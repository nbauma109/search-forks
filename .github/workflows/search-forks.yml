name: Search Forks For Keyword

on:
  workflow_dispatch:
    inputs:
      keyword:
        description: "Keyword to search in commit messages"
        required: true
        type: string
      owner:
        description: "GitHub repository owner"
        required: true
        type: string
      repo:
        description: "Repository name"
        required: true
        type: string

jobs:
  search:
    runs-on: ubuntu-latest

    steps:
      - name: Display Inputs
        run: |
          echo "Keyword: ${{ github.event.inputs.keyword }}"
          echo "Owner:   ${{ github.event.inputs.owner }}"
          echo "Repo:    ${{ github.event.inputs.repo }}"

      - name: Install Git
        run: sudo apt-get update && sudo apt-get install -y git

      - name: Run Search Script
        run: |
          set -euo pipefail

          KEYWORD="${{ github.event.inputs.keyword }}"
          OWNER="${{ github.event.inputs.owner }}"
          REPO="${{ github.event.inputs.repo }}"
          API="https://api.github.com/repos/${OWNER}/${REPO}/forks"
          CLONE_ROOT="forks_${OWNER}_${REPO}"

          mkdir -p "${CLONE_ROOT}"

          list_all_forks() {
              page=1
              while true; do
                  url="${API}?per_page=100&page=${page}"
                  echo "Retrieving page ${page} of forks..."
                  response=$(curl -s "${url}")
                  count=$(echo "${response}" | grep -c '"full_name"' || true)
                  if [ "${count}" -eq 0 ]; then
                      break
                  fi
                  echo "${response}" \
                    | grep '"full_name"' \
                    | sed 's/.*"full_name": "\(.*\)".*/\1/'
                  page=$((page + 1))
                  sleep 1
              done
          }

          clone_repository() {
              full_name="$1"
              url="https://github.com/${full_name}.git"
              target="${CLONE_ROOT}/${full_name//\//_}"
              if [ -d "${target}" ]; then
                  echo "${target}"
                  return
              fi
              echo "Cloning ${full_name}..."
              if git clone --depth 50 "${url}" "${target}" >/dev/null 2>&1; then
                  echo "${target}"
              else
                  echo ""
              fi
          }

          contains_keyword_commit() {
              path="$1"
              if git -C "${path}" log --all --grep="${KEYWORD}" >/dev/null 2>&1; then
                  return 0
              else
                  return 1
              fi
          }

          echo "Gathering forks for ${OWNER}/${REPO}..."
          forks=$(list_all_forks)
          echo "Total forks discovered: $(echo "${forks}" | wc -l)"

          echo
          echo "Searching commit messages for keyword: ${KEYWORD}"
          echo

          while IFS= read -r fork; do
              [ -z "${fork}" ] && continue
              echo "Processing fork: ${fork}"

              repo_path=$(clone_repository "${fork}")
              if [ -z "${repo_path}" ]; then
                  echo "Repository clone failed: ${fork}"
                  continue
              fi

              if contains_keyword_commit "${repo_path}"; then
                  echo ">>> Keyword found in commit messages: ${fork}"
              fi
          done <<< "${forks}"

          echo
          echo "Search completed."
