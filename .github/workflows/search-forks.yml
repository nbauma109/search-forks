name: Search Forks For Keyword

on:
  workflow_dispatch:
    inputs:
      owner:
        description: "GitHub repository owner"
        required: true
        type: string
      repo:
        description: "Repository name"
        required: true
        type: string
      keyword:
        description: "Keyword to search in commit messages"
        required: true
        type: string

jobs:
  search:
    runs-on: ubuntu-latest

    steps:
      - name: Prepare environment
        run: |
          sudo apt-get update
          sudo apt-get install -y git
          touch results.csv

      - name: Run fork search
        run: |
          set -euo pipefail

          OWNER="${{ github.event.inputs.owner }}"
          REPO="${{ github.event.inputs.repo }}"
          KEYWORD="${{ github.event.inputs.keyword }}"
          API="https://api.github.com/repos/${OWNER}/${REPO}/forks"
          CLONE_ROOT="forks_${OWNER}_${REPO}"

          mkdir -p "${CLONE_ROOT}"
          echo -n "" > results.csv

          list_all_forks() {
              page=1
              while true; do
                  url="${API}?per_page=100&page=${page}"
                  echo "Retrieving page ${page} of forks..."
                  response=$(curl -s "${url}")
                  count=$(echo "${response}" | grep -c '"full_name"' || true)
                  if [ "${count}" -eq 0 ]; then
                      break
                  fi
                  echo "${response}" \
                    | grep '"full_name"' \
                    | sed 's/.*"full_name": "\(.*\)".*/\1/'
                  page=$((page + 1))
                  sleep 1
              done
          }

          clone_repository() {
              full_name="$1"
              url="https://github.com/${full_name}.git"
              target="${CLONE_ROOT}/${full_name//\//_}"

              if [ -d "${target}" ]; then
                  echo "${target}"
                  return
              fi

              echo "Cloning ${full_name}..."
              if git clone --depth 50 "${url}" "${target}" >/dev/null 2>&1; then
                  echo "${target}"
              else
                  echo ""
              fi
          }

          contains_keyword_commit() {
              path="$1"
              git -C "${path}" log --all --grep="${KEYWORD}" >/dev/null 2>&1
          }

          echo "Gathering forks..."
          forks=$(list_all_forks)
          echo "Total forks discovered: $(echo "${forks}" | wc -l)"

          while IFS= read -r fork; do
              [ -z "${fork}" ] && continue

              echo "Processing fork: ${fork}"

              repo_path=$(clone_repository "${fork}")
              if [ -z "${repo_path}" ]; then
                  echo "Clone failed: ${fork}"
                  continue
              fi

              if contains_keyword_commit "${repo_path}"; then
                  commit=$(git -C "${repo_path}" log --all --grep="${KEYWORD}" --pretty=format:"%H" -n 1)
                  message=$(git -C "${repo_path}" log --all --grep="${KEYWORD}" --pretty=format:"%s" -n 1)
                  url="https://github.com/${fork}/commit/${commit}"

                  echo "${fork},${commit},${message},${url}" >> results.csv
                  echo "Match found: ${fork}"
              fi
          done <<< "${forks}"

      - name: Write summary
        run: |
          echo "## Fork Commit Search Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** \`${{ github.event.inputs.owner }}/${{ github.event.inputs.repo }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Keyword:** \`${{ github.event.inputs.keyword }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ ! -s results.csv ]; then
            echo "No matches found." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          echo "| Fork | Commit | Message |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|----------|" >> $GITHUB_STEP_SUMMARY

          while IFS=',' read -r fork commit message url
          do
            echo "| [$fork]($url) | \`${commit}\` | ${message} |" >> $GITHUB_STEP_SUMMARY
          done < results.csv

      - name: Upload CSV results
        uses: actions/upload-artifact@v4
        with:
          name: fork-search-results
          path: results.csv
